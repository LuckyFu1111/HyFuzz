# HyFuzz Vulnerability Scanner Guide

## Overview

The HyFuzz vulnerability scanner is an advanced pattern-matching system designed to detect security vulnerabilities in code, logs, and execution outputs. It supports both simple string matching and complex regex patterns with CWE classification.

## Features

- **Regex Pattern Matching**: Use regular expressions for precise vulnerability detection
- **CWE Integration**: Automatically classify vulnerabilities with CWE (Common Weakness Enumeration) IDs
- **Severity Levels**: Critical, High, Medium, Low, and Info classifications
- **Detailed Findings**: Context, line numbers, and confidence scores for each finding
- **Performance Metrics**: Track scan time and lines scanned
- **Extensible**: Easy to add custom patterns
- **Backward Compatible**: Works with legacy string-based patterns

## Quick Start

### Basic Usage

```python
from scanning.vulnerability_scanner import VulnerabilityScanner

# Create scanner with default patterns
scanner = VulnerabilityScanner()

# Scan some data
result = scanner.scan("Found buffer overflow in main()")

# Check results
print(f"Found {len(result.findings)} vulnerabilities")
for finding in result.findings:
    print(f"  - {finding.severity.value}: {finding.description} ({finding.cwe_id})")
```

### Scan a File

```python
# Scan a source file
result = scanner.scan_file("/path/to/code.c")

# Get severity summary
summary = result.get_severity_summary()
print(f"Critical: {summary['critical']}")
print(f"High: {summary['high']}")
print(f"Medium: {summary['medium']}")
```

## Built-in Vulnerability Patterns

The scanner includes 25+ pre-configured patterns:

### Memory Corruption (CWE-120, CWE-121, CWE-122, CWE-415, CWE-416, CWE-476)
- Buffer overflow (stack, heap)
- Use after free
- Double free
- NULL pointer dereference

### Injection Attacks (CWE-77, CWE-89, CWE-90, CWE-94)
- SQL injection
- Command injection
- Code injection
- LDAP injection

### Web Vulnerabilities (CWE-79, CWE-22)
- Cross-site scripting (XSS)
- Path traversal
- Directory traversal

### Authentication & Authorization (CWE-269, CWE-287)
- Authentication bypass
- Privilege escalation

### Cryptographic Issues (CWE-327, CWE-798)
- Weak encryption
- Hardcoded credentials

### Other Vulnerabilities
- Integer overflow/underflow (CWE-190, CWE-191)
- Race conditions (CWE-362, CWE-367)
- Information disclosure (CWE-200)
- Format string vulnerabilities (CWE-134)

## Adding Custom Patterns

### Simple String Pattern

```python
scanner = VulnerabilityScanner()

scanner.add_pattern(
    pattern="my custom vulnerability",
    is_regex=False,
    severity=SeverityLevel.MEDIUM,
    description="Custom vulnerability type"
)
```

### Regex Pattern with CWE

```python
scanner.add_pattern(
    pattern=r"eval\s*\(",
    is_regex=True,
    severity=SeverityLevel.HIGH,
    cwe_id="CWE-95",
    description="Improper neutralization of directives in dynamically evaluated code"
)
```

## Understanding Scan Results

### ScanResult Object

```python
result = scanner.scan(data)

# Basic information
print(f"Target: {result.target}")
print(f"Scan time: {result.scan_time:.4f}s")
print(f"Lines scanned: {result.lines_scanned}")

# Legacy compatibility
print(f"Issues found: {result.issues}")

# Detailed findings
for finding in result.findings:
    print(f"\nSeverity: {finding.severity.value}")
    print(f"CWE ID: {finding.cwe_id}")
    print(f"Description: {finding.description}")
    print(f"Line: {finding.line_number}")
    print(f"Context: {finding.context}")
    print(f"Confidence: {finding.confidence:.2f}")
```

### Severity Summary

```python
summary = result.get_severity_summary()
# Returns: {'critical': 2, 'high': 5, 'medium': 3, 'low': 1, 'info': 0}

highest = result.get_highest_severity()
# Returns: SeverityLevel.CRITICAL
```

### Convert to Dictionary

```python
result_dict = result.to_dict()
# Includes all findings, summary, and metadata
```

## Integration with Defense System

The vulnerability scanner integrates with HyFuzz's defense system:

```python
from scanning.vulnerability_scanner import VulnerabilityScanner
from defense.defense_integrator import DefenseIntegrator
from defense.defense_models import DefenseEvent, DefenseSignal

# Scan for vulnerabilities
scanner = VulnerabilityScanner()
scan_result = scanner.scan(execution_output)

# Send to defense system
if scan_result.findings:
    integrator = DefenseIntegrator()

    event = DefenseEvent(
        source='vulnerability_scanner',
        payload={
            'findings': [f.to_dict() for f in scan_result.findings],
            'severity': scan_result.get_highest_severity().value,
            'target': scan_result.target
        },
        tags=['vulnerability', 'automated-scan']
    )

    # Determine severity for defense signal
    highest = scan_result.get_highest_severity()
    severity_map = {
        SeverityLevel.CRITICAL: 'critical',
        SeverityLevel.HIGH: 'high',
        SeverityLevel.MEDIUM: 'medium',
        SeverityLevel.LOW: 'low',
        SeverityLevel.INFO: 'info'
    }

    signal = DefenseSignal(
        event=event,
        severity=severity_map[highest],
        confidence=0.9
    )

    defense_result = integrator.process_signal(signal)
    print(f"Defense verdict: {defense_result.verdict}")
    print(f"Risk score: {defense_result.risk_score:.2f}")
```

## Configuration

### Custom Pattern Set

```python
# Create scanner without default patterns
scanner = VulnerabilityScanner(patterns=[], enhanced_patterns=[])

# Add only the patterns you need
scanner.add_pattern("sql injection", is_regex=False, severity=SeverityLevel.CRITICAL)
scanner.add_pattern(r"buffer\s+overflow", is_regex=True, severity=SeverityLevel.HIGH)
```

### Adjust Context Length

```python
# Increase context length for findings
scanner = VulnerabilityScanner(max_context_length=200)
```

## Performance Considerations

### Large Files

For large files, consider:

```python
# Use scan_file() for proper memory management
result = scanner.scan_file("/path/to/large/file.txt")

# Check scan time
if result.scan_time > 1.0:
    print("Warning: Slow scan detected")
```

### Batch Scanning

```python
import os

results = []
for filename in os.listdir("/code/directory"):
    if filename.endswith(".c"):
        result = scanner.scan_file(os.path.join("/code/directory", filename))
        results.append(result)

# Aggregate results
total_findings = sum(len(r.findings) for r in results)
critical_count = sum(
    sum(1 for f in r.findings if f.severity == SeverityLevel.CRITICAL)
    for r in results
)

print(f"Total findings: {total_findings}")
print(f"Critical vulnerabilities: {critical_count}")
```

## Best Practices

### 1. Use Appropriate Severity Levels

```python
# Critical: Remote code execution, authentication bypass
SeverityLevel.CRITICAL

# High: Memory corruption, injection attacks
SeverityLevel.HIGH

# Medium: Information disclosure, weak crypto
SeverityLevel.MEDIUM

# Low: Minor issues, best practice violations
SeverityLevel.LOW

# Info: Informational findings, suggestions
SeverityLevel.INFO
```

### 2. Provide Descriptive Patterns

```python
scanner.add_pattern(
    pattern=r"strcpy\s*\(",
    is_regex=True,
    severity=SeverityLevel.HIGH,
    cwe_id="CWE-120",
    description="Use of dangerous function strcpy() which can cause buffer overflow"
)
```

### 3. Use Regex for Complex Patterns

```python
# Good: Matches various forms of SQL injection
scanner.add_pattern(
    pattern=r"(SELECT|INSERT|UPDATE|DELETE).*WHERE.*=.*['\"]?\s*\+\s*",
    is_regex=True,
    severity=SeverityLevel.CRITICAL,
    cwe_id="CWE-89"
)

# Better: More specific pattern
scanner.add_pattern(
    pattern=r"execute\s*\(\s*['\"]SELECT.*['\"].*\+",
    is_regex=True,
    severity=SeverityLevel.CRITICAL,
    cwe_id="CWE-89"
)
```

### 4. Monitor Scanner Statistics

```python
stats = scanner.get_statistics()
print(f"Total patterns: {stats['total_patterns']}")
print(f"Patterns with CWE: {stats['patterns_with_cwe']}")
print(f"By severity: {stats['patterns_by_severity']}")
```

## Troubleshooting

### No Vulnerabilities Found

```python
# Check if scanner has patterns loaded
stats = scanner.get_statistics()
if stats['total_patterns'] == 0:
    print("No patterns loaded!")

# Test with known vulnerability
test_result = scanner.scan("buffer overflow detected")
if len(test_result.findings) == 0:
    print("Scanner may not be working correctly")
```

### False Positives

```python
# Adjust confidence thresholds
high_confidence = [
    f for f in result.findings
    if f.confidence >= 0.8
]

# Filter by severity
critical_only = [
    f for f in result.findings
    if f.severity == SeverityLevel.CRITICAL
]
```

### Performance Issues

```python
import time

start = time.time()
result = scanner.scan(large_data)
elapsed = time.time() - start

if elapsed > 1.0:
    print(f"Slow scan: {elapsed:.2f}s for {result.lines_scanned} lines")
    print(f"Consider optimizing patterns or splitting data")
```

## API Reference

### VulnerabilityScanner

- `__init__(patterns=[], enhanced_patterns=[], max_context_length=100)`
- `scan(data: str) -> ScanResult`
- `scan_file(file_path: str) -> ScanResult`
- `add_pattern(pattern, is_regex, severity, cwe_id, description)`
- `get_statistics() -> Dict`

### ScanResult

- `target: str` - Target identifier
- `issues: List[str]` - List of matched patterns (legacy)
- `findings: List[VulnerabilityFinding]` - Detailed findings
- `scan_time: float` - Time taken to scan
- `lines_scanned: int` - Number of lines scanned
- `to_dict() -> Dict`
- `get_severity_summary() -> Dict`
- `get_highest_severity() -> SeverityLevel`

### VulnerabilityFinding

- `pattern: str` - Matched pattern
- `severity: SeverityLevel` - Severity level
- `cwe_id: str` - CWE identifier
- `description: str` - Human-readable description
- `context: str` - Code context where found
- `line_number: int` - Line number in source
- `confidence: float` - Confidence score (0.0-1.0)
- `to_dict() -> Dict`

### SeverityLevel

- `CRITICAL` - Critical severity
- `HIGH` - High severity
- `MEDIUM` - Medium severity
- `LOW` - Low severity
- `INFO` - Informational

## Examples

### Example 1: Scan Campaign Results

```python
from scanning.vulnerability_scanner import VulnerabilityScanner, SeverityLevel

scanner = VulnerabilityScanner()

# Scan execution results from fuzzing campaign
for execution_result in campaign_results:
    scan_result = scanner.scan(execution_result.output)

    if scan_result.findings:
        print(f"\n{'='*60}")
        print(f"Target: {execution_result.payload_id}")
        print(f"Found {len(scan_result.findings)} vulnerabilities")

        for finding in scan_result.findings:
            if finding.severity in (SeverityLevel.CRITICAL, SeverityLevel.HIGH):
                print(f"\n  [{finding.severity.value.upper()}] {finding.description}")
                print(f"  CWE: {finding.cwe_id}")
                print(f"  Line: {finding.line_number}")
                print(f"  Context: {finding.context[:80]}...")
```

### Example 2: Custom Pattern for Specific Protocol

```python
# Add patterns specific to CoAP protocol
scanner = VulnerabilityScanner()

scanner.add_pattern(
    pattern=r"CoAP\s+amplification",
    is_regex=True,
    severity=SeverityLevel.HIGH,
    cwe_id="CWE-400",
    description="CoAP amplification attack vulnerability"
)

scanner.add_pattern(
    pattern=r"observe\s+option.*unlimited",
    is_regex=True,
    severity=SeverityLevel.MEDIUM,
    cwe_id="CWE-400",
    description="Unlimited CoAP observe subscriptions"
)

# Scan CoAP traffic
result = scanner.scan(coap_traffic_log)
```

### Example 3: Generate Security Report

```python
def generate_security_report(scan_results):
    """Generate a comprehensive security report."""
    report = []
    report.append("# Security Scan Report\n")

    all_findings = []
    for result in scan_results:
        all_findings.extend(result.findings)

    # Summary
    report.append(f"## Summary")
    report.append(f"- Total scans: {len(scan_results)}")
    report.append(f"- Total findings: {len(all_findings)}")

    # By severity
    from collections import Counter
    severity_counts = Counter(f.severity for f in all_findings)
    report.append(f"\n## By Severity")
    for severity in [SeverityLevel.CRITICAL, SeverityLevel.HIGH,
                    SeverityLevel.MEDIUM, SeverityLevel.LOW]:
        count = severity_counts[severity]
        if count > 0:
            report.append(f"- {severity.value.title()}: {count}")

    # Top CVEs
    cwe_counts = Counter(f.cwe_id for f in all_findings if f.cwe_id)
    report.append(f"\n## Top CWEs")
    for cwe, count in cwe_counts.most_common(5):
        report.append(f"- {cwe}: {count} occurrences")

    # Critical findings
    critical = [f for f in all_findings if f.severity == SeverityLevel.CRITICAL]
    if critical:
        report.append(f"\n## Critical Findings")
        for finding in critical[:10]:  # Top 10
            report.append(f"\n### {finding.description}")
            report.append(f"- CWE: {finding.cwe_id}")
            report.append(f"- Context: `{finding.context}`")

    return "\n".join(report)

# Usage
scanner = VulnerabilityScanner()
results = [scanner.scan_file(f) for f in source_files]
report = generate_security_report(results)
print(report)
```

## See Also

- [HyFuzz System Audit Report](SYSTEM_AUDIT_REPORT.md)
- [Defense System Integration](ARCHITECTURE.md#defense-system)
- [CWE Database](https://cwe.mitre.org/)
