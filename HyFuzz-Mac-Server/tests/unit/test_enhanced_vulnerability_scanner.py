"""Tests for enhanced vulnerability scanner."""

import pytest
from src.scanning.vulnerability_scanner import (
    VulnerabilityScanner,
    VulnerabilityPattern,
    SeverityLevel,
    VulnerabilityFinding,
    ScanResult,
)


class TestVulnerabilityPattern:
    """Test VulnerabilityPattern class."""

    def test_string_pattern_matching(self):
        """Test simple string pattern matching."""
        pattern = VulnerabilityPattern(
            pattern="sql injection",
            is_regex=False,
            severity=SeverityLevel.CRITICAL
        )
        assert pattern.matches("Found SQL injection vulnerability")
        assert pattern.matches("sql INJECTION detected")
        assert not pattern.matches("No issues found")

    def test_regex_pattern_matching(self):
        """Test regex pattern matching."""
        pattern = VulnerabilityPattern(
            pattern=r"buffer\s+overflow",
            is_regex=True,
            severity=SeverityLevel.HIGH
        )
        assert pattern.matches("buffer overflow detected")
        assert pattern.matches("BUFFER   OVERFLOW found")
        assert not pattern.matches("bufferoverflow")

    def test_invalid_regex_pattern(self):
        """Test that invalid regex patterns raise ValueError."""
        with pytest.raises(ValueError):
            VulnerabilityPattern(
                pattern="[invalid(regex",
                is_regex=True
            )

    def test_pattern_with_metadata(self):
        """Test pattern with full metadata."""
        pattern = VulnerabilityPattern(
            pattern="xss",
            is_regex=False,
            severity=SeverityLevel.HIGH,
            cwe_id="CWE-79",
            description="Cross-site scripting"
        )
        assert pattern.cwe_id == "CWE-79"
        assert pattern.severity == SeverityLevel.HIGH
        assert pattern.description == "Cross-site scripting"


class TestVulnerabilityFinding:
    """Test VulnerabilityFinding class."""

    def test_finding_creation(self):
        """Test creating a vulnerability finding."""
        finding = VulnerabilityFinding(
            pattern="sql injection",
            severity=SeverityLevel.CRITICAL,
            cwe_id="CWE-89",
            description="SQL injection vulnerability",
            context="SELECT * FROM users WHERE id = ' OR '1'='1",
            line_number=42,
            confidence=0.95
        )
        assert finding.pattern == "sql injection"
        assert finding.severity == SeverityLevel.CRITICAL
        assert finding.cwe_id == "CWE-89"
        assert finding.line_number == 42
        assert finding.confidence == 0.95

    def test_finding_to_dict(self):
        """Test converting finding to dictionary."""
        finding = VulnerabilityFinding(
            pattern="buffer overflow",
            severity=SeverityLevel.HIGH,
            cwe_id="CWE-120"
        )
        result = finding.to_dict()
        assert result["pattern"] == "buffer overflow"
        assert result["severity"] == "high"
        assert result["cwe_id"] == "CWE-120"
        assert "confidence" in result


class TestScanResult:
    """Test ScanResult class."""

    def test_scan_result_creation(self):
        """Test creating a scan result."""
        result = ScanResult(
            target="test.c",
            issues=["buffer overflow", "sql injection"],
            findings=[
                VulnerabilityFinding("buffer overflow", SeverityLevel.HIGH),
                VulnerabilityFinding("sql injection", SeverityLevel.CRITICAL)
            ]
        )
        assert result.target == "test.c"
        assert len(result.issues) == 2
        assert len(result.findings) == 2

    def test_severity_summary(self):
        """Test getting severity summary."""
        result = ScanResult(
            target="test",
            issues=[],
            findings=[
                VulnerabilityFinding("vuln1", SeverityLevel.HIGH),
                VulnerabilityFinding("vuln2", SeverityLevel.HIGH),
                VulnerabilityFinding("vuln3", SeverityLevel.CRITICAL),
                VulnerabilityFinding("vuln4", SeverityLevel.MEDIUM),
            ]
        )
        summary = result.get_severity_summary()
        assert summary["critical"] == 1
        assert summary["high"] == 2
        assert summary["medium"] == 1
        assert summary["low"] == 0

    def test_highest_severity(self):
        """Test getting highest severity."""
        result = ScanResult(
            target="test",
            issues=[],
            findings=[
                VulnerabilityFinding("vuln1", SeverityLevel.MEDIUM),
                VulnerabilityFinding("vuln2", SeverityLevel.HIGH),
                VulnerabilityFinding("vuln3", SeverityLevel.LOW),
            ]
        )
        assert result.get_highest_severity() == SeverityLevel.HIGH

    def test_highest_severity_empty(self):
        """Test highest severity with no findings."""
        result = ScanResult(target="test", issues=[], findings=[])
        assert result.get_highest_severity() is None

    def test_scan_result_to_dict(self):
        """Test converting scan result to dictionary."""
        result = ScanResult(
            target="test",
            issues=["issue1"],
            findings=[VulnerabilityFinding("vuln", SeverityLevel.HIGH)],
            scan_time=0.5,
            lines_scanned=100
        )
        d = result.to_dict()
        assert d["target"] == "test"
        assert d["scan_time"] == 0.5
        assert d["lines_scanned"] == 100
        assert "severity_summary" in d
        assert len(d["findings"]) == 1


class TestVulnerabilityScanner:
    """Test VulnerabilityScanner class."""

    def test_scanner_initialization(self):
        """Test scanner initializes with default patterns."""
        scanner = VulnerabilityScanner()
        assert len(scanner.enhanced_patterns) > 0

    def test_scanner_with_legacy_patterns(self):
        """Test scanner with legacy string patterns."""
        scanner = VulnerabilityScanner(patterns=["test pattern", "another pattern"])
        assert len(scanner.patterns) == 2
        assert len(scanner.enhanced_patterns) == 0  # Should not load defaults

    def test_simple_scan(self):
        """Test simple vulnerability scan."""
        scanner = VulnerabilityScanner()
        result = scanner.scan("Found buffer overflow in main function")

        assert len(result.findings) > 0
        assert result.scan_time >= 0
        assert result.lines_scanned > 0
        assert any("buffer" in issue.lower() for issue in result.issues)

    def test_scan_multiple_vulnerabilities(self):
        """Test scanning text with multiple vulnerabilities."""
        scanner = VulnerabilityScanner()
        text = """
        This code has multiple issues:
        1. Buffer overflow in line 10
        2. SQL injection vulnerability
        3. Use after free detected
        4. Authentication bypass possible
        """
        result = scanner.scan(text)

        assert len(result.findings) >= 4
        assert result.get_highest_severity() == SeverityLevel.CRITICAL

    def test_scan_no_vulnerabilities(self):
        """Test scanning clean text."""
        scanner = VulnerabilityScanner()
        result = scanner.scan("This is perfectly safe code with no issues")

        assert len(result.findings) == 0
        assert len(result.issues) == 0
        assert result.get_highest_severity() is None

    def test_add_custom_pattern(self):
        """Test adding custom patterns."""
        scanner = VulnerabilityScanner()
        initial_count = len(scanner.enhanced_patterns)

        scanner.add_pattern(
            pattern="custom vulnerability",
            is_regex=False,
            severity=SeverityLevel.HIGH,
            cwe_id="CWE-999",
            description="Custom test vulnerability"
        )

        assert len(scanner.enhanced_patterns) == initial_count + 1
        result = scanner.scan("Found custom vulnerability in code")
        assert len(result.findings) > 0

    def test_scan_with_context(self):
        """Test that scan captures context and line numbers."""
        scanner = VulnerabilityScanner()
        text = "Line 1\nLine 2: buffer overflow here\nLine 3"
        result = scanner.scan(text)

        assert len(result.findings) > 0
        finding = result.findings[0]
        assert finding.line_number is not None
        assert finding.context != ""

    def test_scanner_statistics(self):
        """Test getting scanner statistics."""
        scanner = VulnerabilityScanner()
        stats = scanner.get_statistics()

        assert "total_patterns" in stats
        assert "enhanced_patterns" in stats
        assert "patterns_by_severity" in stats
        assert "patterns_with_cwe" in stats
        assert stats["total_patterns"] > 0

    def test_backward_compatibility(self):
        """Test that legacy interface still works."""
        scanner = VulnerabilityScanner(patterns=["test", "pattern"])
        result = scanner.scan("This has test data")

        assert isinstance(result, ScanResult)
        assert isinstance(result.issues, list)
        assert result.target
        # Legacy behavior - issues list should be populated
        assert len(result.issues) > 0

    def test_case_insensitive_matching(self):
        """Test that matching is case-insensitive."""
        scanner = VulnerabilityScanner()
        test_cases = [
            "BUFFER OVERFLOW",
            "Buffer Overflow",
            "buffer overflow",
            "BuFfEr OvErFlOw",
        ]

        for text in test_cases:
            result = scanner.scan(text)
            assert len(result.findings) > 0, f"Failed to match: {text}"

    def test_regex_patterns(self):
        """Test that regex patterns work correctly."""
        scanner = VulnerabilityScanner()

        # Should match "buffer overflow" with various whitespace
        test_cases = [
            "buffer overflow",
            "buffer  overflow",
            "buffer   overflow",
            "buffer\toverflow",
        ]

        for text in test_cases:
            result = scanner.scan(text)
            assert len(result.findings) > 0, f"Failed to match: {repr(text)}"

    def test_cwe_ids_present(self):
        """Test that findings include CWE IDs."""
        scanner = VulnerabilityScanner()
        result = scanner.scan("SQL injection and buffer overflow found")

        assert len(result.findings) > 0
        cwe_findings = [f for f in result.findings if f.cwe_id]
        assert len(cwe_findings) > 0
        assert all(f.cwe_id.startswith("CWE-") for f in cwe_findings)

    def test_severity_levels(self):
        """Test that different severity levels are assigned."""
        scanner = VulnerabilityScanner()
        text = """
        Critical: use after free, SQL injection, authentication bypass
        High: buffer overflow, XSS
        Medium: integer overflow, information disclosure
        """
        result = scanner.scan(text)

        severities = {f.severity for f in result.findings}
        assert SeverityLevel.CRITICAL in severities
        assert SeverityLevel.HIGH in severities

    def test_confidence_scores(self):
        """Test that findings include confidence scores."""
        scanner = VulnerabilityScanner()
        result = scanner.scan("buffer overflow detected")

        assert len(result.findings) > 0
        for finding in result.findings:
            assert 0.0 <= finding.confidence <= 1.0


class TestScannerIntegration:
    """Integration tests for the scanner."""

    def test_full_scan_workflow(self):
        """Test complete scanning workflow."""
        # Create scanner with custom patterns
        scanner = VulnerabilityScanner()
        scanner.add_pattern(
            pattern=r"TODO:\s*fix\s+security",
            is_regex=True,
            severity=SeverityLevel.LOW,
            description="Security TODO comment"
        )

        # Scan sample code
        code = """
        int main() {
            char buffer[10];
            // TODO: fix security issue here
            strcpy(buffer, user_input);  // buffer overflow
            sql_query("SELECT * FROM users WHERE id = " + user_id);  // SQL injection
            return 0;
        }
        """

        result = scanner.scan(code)

        # Verify results
        assert len(result.findings) >= 2  # At least buffer overflow and SQL injection
        assert result.scan_time > 0
        assert result.lines_scanned > 0

        # Check we found high severity issues
        high_severity = [f for f in result.findings if f.severity in (SeverityLevel.HIGH, SeverityLevel.CRITICAL)]
        assert len(high_severity) > 0

        # Check result can be converted to dict
        result_dict = result.to_dict()
        assert "findings" in result_dict
        assert "severity_summary" in result_dict

    def test_scanner_performance(self):
        """Test scanner performance on larger text."""
        scanner = VulnerabilityScanner()

        # Generate large test data
        large_text = "Safe code line\n" * 1000
        large_text += "buffer overflow here\n"
        large_text += "Safe code line\n" * 1000

        result = scanner.scan(large_text)

        # Should complete quickly
        assert result.scan_time < 1.0  # Less than 1 second
        assert len(result.findings) > 0  # Should find the vulnerability
        assert result.lines_scanned == 2001


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
