"""Enhanced vulnerability scanner with regex support and CVE classification."""

from __future__ import annotations
import re
from dataclasses import dataclass, field
from typing import Any, Dict, List, Optional, Pattern
from enum import Enum


class SeverityLevel(str, Enum):
    """Vulnerability severity levels."""
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"


@dataclass
class VulnerabilityPattern:
    """Enhanced pattern with metadata."""
    pattern: str
    is_regex: bool = False
    severity: SeverityLevel = SeverityLevel.MEDIUM
    cwe_id: Optional[str] = None
    description: str = ""
    compiled: Optional[Pattern] = field(default=None, repr=False)

    def __post_init__(self):
        """Compile regex patterns."""
        if self.is_regex and not self.compiled:
            try:
                self.compiled = re.compile(self.pattern, re.IGNORECASE)
            except re.error as e:
                raise ValueError(f"Invalid regex pattern '{self.pattern}': {e}")

    def matches(self, data: str) -> bool:
        """Check if pattern matches data."""
        if self.is_regex and self.compiled:
            return bool(self.compiled.search(data))
        return self.pattern.lower() in data.lower()


@dataclass
class VulnerabilityFinding:
    """Detailed vulnerability finding."""
    pattern: str
    severity: SeverityLevel
    cwe_id: Optional[str] = None
    description: str = ""
    context: str = ""
    line_number: Optional[int] = None
    confidence: float = 1.0

    def to_dict(self) -> Dict[str, Any]:
        """Convert to dictionary."""
        return {
            "pattern": self.pattern,
            "severity": self.severity.value,
            "cwe_id": self.cwe_id,
            "description": self.description,
            "context": self.context,
            "line_number": self.line_number,
            "confidence": self.confidence,
        }


@dataclass
class ScanResult:
    """Enhanced scan result with detailed findings."""
    target: str
    issues: List[str]  # Keep for backward compatibility
    findings: List[VulnerabilityFinding] = field(default_factory=list)
    scan_time: float = 0.0
    lines_scanned: int = 0

    def to_dict(self) -> Dict[str, Any]:
        """Convert to dictionary."""
        return {
            "target": self.target,
            "issues": self.issues,
            "findings": [f.to_dict() for f in self.findings],
            "scan_time": self.scan_time,
            "lines_scanned": self.lines_scanned,
            "severity_summary": self.get_severity_summary(),
        }

    def get_severity_summary(self) -> Dict[str, int]:
        """Get count of findings by severity."""
        summary = {level.value: 0 for level in SeverityLevel}
        for finding in self.findings:
            summary[finding.severity.value] += 1
        return summary

    def get_highest_severity(self) -> Optional[SeverityLevel]:
        """Get the highest severity level found."""
        if not self.findings:
            return None
        severity_order = [
            SeverityLevel.CRITICAL,
            SeverityLevel.HIGH,
            SeverityLevel.MEDIUM,
            SeverityLevel.LOW,
            SeverityLevel.INFO,
        ]
        for severity in severity_order:
            if any(f.severity == severity for f in self.findings):
                return severity
        return None


@dataclass
class VulnerabilityScanner:
    """Enhanced vulnerability scanner with regex and CVE support."""

    patterns: List[str] = field(default_factory=list)
    enhanced_patterns: List[VulnerabilityPattern] = field(default_factory=list)
    max_context_length: int = 100

    def __post_init__(self):
        """Initialize default patterns if none provided."""
        if not self.patterns and not self.enhanced_patterns:
            self._load_default_patterns()

    def _load_default_patterns(self) -> None:
        """Load default vulnerability patterns."""
        self.enhanced_patterns = [
            # Buffer overflow patterns
            VulnerabilityPattern(
                pattern=r"buffer\s+overflow",
                is_regex=True,
                severity=SeverityLevel.HIGH,
                cwe_id="CWE-120",
                description="Buffer overflow vulnerability"
            ),
            VulnerabilityPattern(
                pattern=r"stack\s+overflow",
                is_regex=True,
                severity=SeverityLevel.HIGH,
                cwe_id="CWE-121",
                description="Stack-based buffer overflow"
            ),
            VulnerabilityPattern(
                pattern=r"heap\s+overflow",
                is_regex=True,
                severity=SeverityLevel.HIGH,
                cwe_id="CWE-122",
                description="Heap-based buffer overflow"
            ),

            # Format string vulnerabilities
            VulnerabilityPattern(
                pattern=r"format\s+string",
                is_regex=True,
                severity=SeverityLevel.HIGH,
                cwe_id="CWE-134",
                description="Format string vulnerability"
            ),

            # Memory corruption
            VulnerabilityPattern(
                pattern=r"use\s+after\s+free",
                is_regex=True,
                severity=SeverityLevel.CRITICAL,
                cwe_id="CWE-416",
                description="Use after free vulnerability"
            ),
            VulnerabilityPattern(
                pattern=r"double\s+free",
                is_regex=True,
                severity=SeverityLevel.HIGH,
                cwe_id="CWE-415",
                description="Double free vulnerability"
            ),
            VulnerabilityPattern(
                pattern=r"null\s+pointer\s+dereference",
                is_regex=True,
                severity=SeverityLevel.MEDIUM,
                cwe_id="CWE-476",
                description="NULL pointer dereference"
            ),

            # Injection vulnerabilities
            VulnerabilityPattern(
                pattern=r"sql\s+injection",
                is_regex=True,
                severity=SeverityLevel.CRITICAL,
                cwe_id="CWE-89",
                description="SQL injection vulnerability"
            ),
            VulnerabilityPattern(
                pattern=r"command\s+injection",
                is_regex=True,
                severity=SeverityLevel.CRITICAL,
                cwe_id="CWE-77",
                description="OS command injection"
            ),
            VulnerabilityPattern(
                pattern=r"code\s+injection",
                is_regex=True,
                severity=SeverityLevel.CRITICAL,
                cwe_id="CWE-94",
                description="Code injection vulnerability"
            ),
            VulnerabilityPattern(
                pattern=r"ldap\s+injection",
                is_regex=True,
                severity=SeverityLevel.HIGH,
                cwe_id="CWE-90",
                description="LDAP injection"
            ),

            # XSS vulnerabilities
            VulnerabilityPattern(
                pattern=r"cross[_\s-]site\s+scripting",
                is_regex=True,
                severity=SeverityLevel.HIGH,
                cwe_id="CWE-79",
                description="Cross-site scripting (XSS)"
            ),
            VulnerabilityPattern(
                pattern=r"\bxss\b",
                is_regex=True,
                severity=SeverityLevel.HIGH,
                cwe_id="CWE-79",
                description="Cross-site scripting (XSS)"
            ),

            # Path traversal
            VulnerabilityPattern(
                pattern=r"path\s+traversal",
                is_regex=True,
                severity=SeverityLevel.HIGH,
                cwe_id="CWE-22",
                description="Path traversal vulnerability"
            ),
            VulnerabilityPattern(
                pattern=r"directory\s+traversal",
                is_regex=True,
                severity=SeverityLevel.HIGH,
                cwe_id="CWE-22",
                description="Directory traversal"
            ),

            # Authentication/Authorization
            VulnerabilityPattern(
                pattern=r"authentication\s+bypass",
                is_regex=True,
                severity=SeverityLevel.CRITICAL,
                cwe_id="CWE-287",
                description="Authentication bypass"
            ),
            VulnerabilityPattern(
                pattern=r"privilege\s+escalation",
                is_regex=True,
                severity=SeverityLevel.CRITICAL,
                cwe_id="CWE-269",
                description="Privilege escalation"
            ),

            # Cryptographic issues
            VulnerabilityPattern(
                pattern=r"weak\s+(encryption|cipher)",
                is_regex=True,
                severity=SeverityLevel.MEDIUM,
                cwe_id="CWE-327",
                description="Use of weak cryptographic algorithm"
            ),
            VulnerabilityPattern(
                pattern=r"hardcoded\s+(password|key|secret)",
                is_regex=True,
                severity=SeverityLevel.HIGH,
                cwe_id="CWE-798",
                description="Hardcoded credentials"
            ),

            # Information disclosure
            VulnerabilityPattern(
                pattern=r"information\s+disclosure",
                is_regex=True,
                severity=SeverityLevel.MEDIUM,
                cwe_id="CWE-200",
                description="Information exposure"
            ),

            # Integer vulnerabilities
            VulnerabilityPattern(
                pattern=r"integer\s+overflow",
                is_regex=True,
                severity=SeverityLevel.MEDIUM,
                cwe_id="CWE-190",
                description="Integer overflow"
            ),
            VulnerabilityPattern(
                pattern=r"integer\s+underflow",
                is_regex=True,
                severity=SeverityLevel.MEDIUM,
                cwe_id="CWE-191",
                description="Integer underflow"
            ),

            # Race conditions
            VulnerabilityPattern(
                pattern=r"race\s+condition",
                is_regex=True,
                severity=SeverityLevel.MEDIUM,
                cwe_id="CWE-362",
                description="Race condition vulnerability"
            ),
            VulnerabilityPattern(
                pattern=r"time[_\s-]of[_\s-]check",
                is_regex=True,
                severity=SeverityLevel.MEDIUM,
                cwe_id="CWE-367",
                description="Time-of-check time-of-use (TOCTOU)"
            ),
        ]

    def add_pattern(
        self,
        pattern: str,
        is_regex: bool = False,
        severity: SeverityLevel = SeverityLevel.MEDIUM,
        cwe_id: Optional[str] = None,
        description: str = ""
    ) -> None:
        """Add a custom vulnerability pattern."""
        vuln_pattern = VulnerabilityPattern(
            pattern=pattern,
            is_regex=is_regex,
            severity=severity,
            cwe_id=cwe_id,
            description=description
        )
        self.enhanced_patterns.append(vuln_pattern)

    def scan(self, data: str) -> ScanResult:
        """
        Scan data for vulnerabilities.

        Args:
            data: Data to scan

        Returns:
            ScanResult with findings
        """
        import time
        start_time = time.time()

        findings: List[VulnerabilityFinding] = []
        issues: List[str] = []  # For backward compatibility
        lines = data.split('\n')

        # Scan with legacy string patterns
        for pattern in self.patterns:
            if pattern.lower() in data.lower():
                issues.append(pattern)
                findings.append(VulnerabilityFinding(
                    pattern=pattern,
                    severity=SeverityLevel.MEDIUM,
                    confidence=0.8
                ))

        # Scan with enhanced patterns
        for vuln_pattern in self.enhanced_patterns:
            if vuln_pattern.matches(data):
                issues.append(vuln_pattern.pattern)

                # Find context and line number
                context = ""
                line_num = None

                for idx, line in enumerate(lines, 1):
                    if vuln_pattern.matches(line):
                        line_num = idx
                        # Get surrounding context
                        start = max(0, len(line) - self.max_context_length // 2)
                        end = min(len(line), start + self.max_context_length)
                        context = line[start:end]
                        break

                findings.append(VulnerabilityFinding(
                    pattern=vuln_pattern.pattern,
                    severity=vuln_pattern.severity,
                    cwe_id=vuln_pattern.cwe_id,
                    description=vuln_pattern.description,
                    context=context.strip(),
                    line_number=line_num,
                    confidence=0.9 if vuln_pattern.is_regex else 0.7
                ))

        scan_time = time.time() - start_time

        return ScanResult(
            target=data[:20] + "..." if len(data) > 20 else data,
            issues=list(set(issues)),  # Remove duplicates
            findings=findings,
            scan_time=scan_time,
            lines_scanned=len(lines)
        )

    def scan_file(self, file_path: str) -> ScanResult:
        """
        Scan a file for vulnerabilities.

        Args:
            file_path: Path to file to scan

        Returns:
            ScanResult with findings
        """
        try:
            with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                data = f.read()
            result = self.scan(data)
            result.target = file_path
            return result
        except Exception as e:
            return ScanResult(
                target=file_path,
                issues=[f"Error scanning file: {str(e)}"],
                findings=[]
            )

    def get_statistics(self) -> Dict[str, Any]:
        """Get scanner statistics."""
        return {
            "total_patterns": len(self.patterns) + len(self.enhanced_patterns),
            "legacy_patterns": len(self.patterns),
            "enhanced_patterns": len(self.enhanced_patterns),
            "patterns_by_severity": {
                level.value: sum(1 for p in self.enhanced_patterns if p.severity == level)
                for level in SeverityLevel
            },
            "patterns_with_cwe": sum(1 for p in self.enhanced_patterns if p.cwe_id),
        }


def _self_test() -> bool:
    """Basic smoke test for module."""
    try:
        scanner = VulnerabilityScanner()
        test_data = "Found buffer overflow and sql injection vulnerabilities"
        result = scanner.scan(test_data)

        assert len(result.findings) > 0, "No findings detected"
        assert result.lines_scanned > 0, "No lines scanned"
        assert result.scan_time >= 0, "Invalid scan time"

        # Test severity summary
        summary = result.get_severity_summary()
        assert isinstance(summary, dict), "Invalid severity summary"

        # Test highest severity
        highest = result.get_highest_severity()
        assert highest is not None, "No highest severity"

        print(f"✓ Self test passed: {len(result.findings)} findings in {result.scan_time:.4f}s")
        print(f"  Severity summary: {summary}")
        print(f"  Highest severity: {highest.value}")

        return True
    except Exception as exc:
        print(f"✗ Self test failed: {exc}")
        import traceback
        traceback.print_exc()
        return False


if __name__ == "__main__":
    print("Enhanced Vulnerability Scanner - Self Test")
    print("=" * 50)
    success = _self_test()

    if success:
        print("\n" + "=" * 50)
        print("Testing pattern matching...")
        scanner = VulnerabilityScanner()

        test_cases = [
            "buffer overflow detected in main()",
            "SQL injection vulnerability found",
            "use after free in memory allocation",
            "authentication bypass possible",
        ]

        for test in test_cases:
            result = scanner.scan(test)
            print(f"\nTest: {test}")
            print(f"  Found {len(result.findings)} issue(s)")
            for finding in result.findings:
                print(f"    - {finding.severity.value}: {finding.description} ({finding.cwe_id})")
